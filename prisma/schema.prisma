// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// PostgreSQL database configuration
// Use docker-compose up -d for local development
// For production, set DATABASE_URL to your PostgreSQL connection string
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  username                 String?   @unique
  password                 String? // Nullable for OAuth-only users
  firstName                String?   @map("first_name")
  lastName                 String?   @map("last_name")
  isActive                 Boolean   @default(true) @map("is_active")
  emailVerified            Boolean   @default(false) @map("email_verified")
  emailVerifiedAt          DateTime? @map("email_verified_at")
  lastLoginAt              DateTime? @map("last_login_at")
  passwordResetToken       String?   @map("password_reset_token")
  passwordResetExpires     DateTime? @map("password_reset_expires")
  passwordChangedAt        DateTime? @map("password_changed_at")
  emailVerificationToken   String?   @map("email_verification_token")
  emailVerificationExpires DateTime? @map("email_verification_expires")
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")

  // Account lockout fields
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")

  // Two-factor authentication
  twoFactorSecret   String? @map("two_factor_secret")
  twoFactorEnabled  Boolean @default(false) @map("two_factor_enabled")
  twoFactorVerified Boolean @default(false) @map("two_factor_verified")

  // Notification preferences (all default to true)
  notifyNewDevice      Boolean @default(true) @map("notify_new_device")
  notifyPasswordChange Boolean @default(true) @map("notify_password_change")
  notifyLoginAlert     Boolean @default(true) @map("notify_login_alert")
  notify2FAChange      Boolean @default(true) @map("notify_2fa_change")

  // Relations
  sessions         UserSession[]
  passwordHistory  PasswordHistory[]
  auditLogs        AuditLog[]
  rememberMeTokens RememberMeToken[]
  backupCodes      BackupCode[]
  sentInvites      OrganizationInvite[]
  oauthAccounts    OAuthAccount[]
  apiKeys          ApiKey[]
  userRoles        UserRole[]
  emailLogs        EmailLog[]

  @@map("users")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  isActive  Boolean  @default(true) @map("is_active")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("user_sessions")
}

model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  password  String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_history")
}

// Platform-wide roles with hierarchy (Symfony-style RBAC)
model Role {
  id          String   @id @default(cuid())
  name        String   @unique // "ROLE_USER", "ROLE_ADMIN", "ROLE_MODERATOR"
  description String?
  parentId    String?  @map("parent_id")
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  parent    Role?      @relation("RoleHierarchy", fields: [parentId], references: [id])
  children  Role[]     @relation("RoleHierarchy")
  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  id             String    @id @default(cuid())
  userId         String    @map("user_id")
  roleId         String    @map("role_id")
  organizationId String?   @map("organization_id") // NULL = platform-wide
  createdAt      DateTime  @default(now()) @map("created_at")

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, organizationId])
  // NOTE: Additional partial unique index in migration for organizationId IS NULL
  @@index([userId])
  @@index([roleId])
  @@index([organizationId])
  @@map("user_roles")
}


model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  category  String
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  metadata  String? // JSON string for SQLite compatibility
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([ipAddress])
  @@map("audit_logs")
}

model RememberMeToken {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash  String   @map("token_hash")
  series     String   @unique
  expiresAt  DateTime @map("expires_at")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  lastUsedAt DateTime @default(now()) @map("last_used_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("remember_me_tokens")
}

model BackupCode {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  codeHash  String    @map("code_hash")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@map("backup_codes")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userRoles UserRole[]
  invites   OrganizationInvite[]

  @@map("organizations")
}

model OrganizationInvite {
  id             String   @id @default(cuid())
  email          String
  roleId         String   @map("role_id") // Role to assign when invite is accepted
  token          String   @unique
  expiresAt      DateTime @map("expires_at")
  organizationId String   @map("organization_id")
  invitedById    String   @map("invited_by_id")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedById], references: [id])

  @@index([email])
  @@index([organizationId])
  @@map("organization_invites")
}

model OAuthAccount {
  id                String    @id @default(cuid())
  userId            String    @map("user_id")
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider          String // "google" | "github"
  providerAccountId String    @map("provider_account_id")
  email             String? // Email from OAuth provider
  accessToken       String?   @map("access_token")
  refreshToken      String?   @map("refresh_token")
  tokenExpiresAt    DateTime? @map("token_expires_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("oauth_accounts")
}

model ApiKey {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String // User-friendly label
  keyHash   String @map("key_hash") // SHA-256 hash of the key
  keyPrefix String @map("key_prefix") // First 8 chars for identification

  permission ApiKeyPermission @default(READ_ONLY)
  expiresAt  DateTime?        @map("expires_at")
  lastUsedAt DateTime?        @map("last_used_at")

  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at") // Soft delete

  @@index([userId])
  @@index([keyHash])
  @@map("api_keys")
}

enum ApiKeyPermission {
  READ_ONLY
  READ_WRITE
}

enum EmailStatus {
  PENDING   // Created, not yet sent
  SENT      // Accepted by provider
  DELIVERED // Confirmed delivered (future: webhook)
  FAILED    // All retries exhausted
  BOUNCED   // Provider reported bounce (future: webhook)

  @@map("email_status")
}

model EmailLog {
  id         String      @id @default(cuid())
  to         String
  userId     String?     @map("user_id")
  user       User?       @relation(fields: [userId], references: [id])
  type       String      // "verification", "password_reset", "invite"
  subject    String
  htmlBody   String      @map("html_body") @db.Text
  status     EmailStatus @default(PENDING)
  attempts   Int         @default(0)
  lastError  String?     @map("last_error")
  sentAt     DateTime?   @map("sent_at")
  provider   String      @default("resend")
  providerId String?     @map("provider_id") // Provider's message ID
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  @@index([to])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("email_logs")
}
